
@page "/pharmacies/{PharmacyId:guid}"
@attribute [Authorize]
@inject ICmsApiClient CmsApiClient
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavigationManager
@using System.Collections.Generic
@using System.Linq
@using System.Security.Claims
@using System.Text.Json
@using MyApp.WebApp.Clients.Models.Requests
@using MyApp.WebApp.Clients.Models.Shared

<PageTitle>@(pharmacy?.Name ?? "Pharmacy")</PageTitle>

@if (isLoading)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading pharmacy...</span>
        </div>
    </div>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger mt-4" role="alert">
        <h2 class="h5">We couldn't load this pharmacy</h2>
        <p class="mb-3">@errorMessage</p>
        <button class="btn btn-outline-secondary" @onclick="NavigateHome">Back to pharmacies</button>
    </div>
}
else if (pharmacy is not null)
{
    <div class="d-flex flex-column flex-lg-row align-items-lg-center gap-3 mb-4">
        <button class="btn btn-outline-secondary btn-sm align-self-start" @onclick="NavigateHome">
            <span class="oi oi-arrow-left me-1" aria-hidden="true"></span>
            Back
        </button>
        <div class="flex-grow-1">
            <h1 class="mb-0">@pharmacy.Name</h1>
            <p class="text-muted mb-1">Created @pharmacy.CreatedAt.LocalDateTime.ToString("dd MMM yyyy")</p>
            @if (pharmacy.UpdatedAt is not null)
            {
                <p class="text-muted mb-0 small">Last updated @pharmacy.UpdatedAt.Value.LocalDateTime.ToString("dd MMM yyyy HH:mm")</p>
            }
        </div>
        <span class="badge bg-@GetStatusColor(pharmacy.IsActive) fs-6 align-self-start">
            @(pharmacy.IsActive ? "Active" : "Inactive")
        </span>
        @if (canManagePharmacy)
        {
            <button class="btn btn-primary" @onclick="TogglePharmacyEdit">
                <span class="oi oi-pencil me-1" aria-hidden="true"></span>
                @(showPharmacyEdit ? "Close form" : "Edit pharmacy")
            </button>
        }
    </div>

    @if (!string.IsNullOrEmpty(alertMessage))
    {
        <div class="alert alert-@alertStyle alert-dismissible fade show" role="alert">
            @alertMessage
            <button type="button" class="btn-close" aria-label="Close" @onclick="() => alertMessage = null"></button>
        </div>
    }

    <section class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <h2 class="h5 mb-3">Overview</h2>
            @if (!string.IsNullOrWhiteSpace(pharmacy.Description))
            {
                <p class="mb-3">@pharmacy.Description</p>
            }
            else
            {
                <p class="text-muted fst-italic mb-3">No description provided.</p>
            }

            <dl class="row mb-0">
                <dt class="col-sm-3">Address</dt>
                <dd class="col-sm-9">@(!string.IsNullOrWhiteSpace(pharmacy.Address) ? pharmacy.Address : "—")</dd>
                <dt class="col-sm-3">Categories</dt>
                <dd class="col-sm-9">@categories.Count</dd>
                <dt class="col-sm-3">Products</dt>
                <dd class="col-sm-9">@products.Count</dd>
            </dl>
        </div>
    </section>

    @if (canManagePharmacy && showPharmacyEdit)
    {
        <section class="card shadow-sm border-0 mb-5">
            <div class="card-header bg-light">
                <h2 class="h5 mb-0">Update pharmacy</h2>
            </div>
            <div class="card-body">
                <EditForm Model="@pharmacyForm" OnValidSubmit="HandlePharmacyUpdateAsync">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Name</label>
                            <InputText class="form-control" @bind-Value="pharmacyForm.Name" />
                            <ValidationMessage For="@(() => pharmacyForm.Name)" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Status</label>
                            <div class="form-check form-switch">
                                <InputCheckbox class="form-check-input" @bind-Value="pharmacyForm.IsActive" />
                                <label class="form-check-label">@((pharmacyForm.IsActive ? "Active" : "Inactive"))</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Description</label>
                            <InputTextArea class="form-control" @bind-Value="pharmacyForm.Description" rows="4" />
                            <ValidationMessage For="@(() => pharmacyForm.Description)" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Address</label>
                            <InputTextArea class="form-control" @bind-Value="pharmacyForm.Address" rows="4" />
                            <ValidationMessage For="@(() => pharmacyForm.Address)" />
                        </div>
                    </div>

                    <div class="mt-4 d-flex gap-2">
                        <button class="btn btn-primary" type="submit" disabled="@isSavingPharmacy">
                            @if (isSavingPharmacy)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            }
                            Save changes
                        </button>
                        <button class="btn btn-outline-secondary" type="button" @onclick="TogglePharmacyEdit">Close</button>
                    </div>
                </EditForm>
            </div>
        </section>
    }

    @if (isClient)
    {
        <section class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-light">
                <div class="d-flex flex-column flex-md-row align-items-md-center gap-3">
                    <h2 class="h5 mb-0">Products</h2>
                    @if (categories.Any(category => category.IsActive))
                    {
                        <div class="ms-md-auto">
                            <select class="form-select form-select-sm w-auto"
                                    value="@selectedCategoryId?.ToString()"
                                    @onchange="OnCategoryFilterChanged">
                                <option value="">All categories</option>
                                @foreach (var category in categories.Where(category => category.IsActive).OrderBy(category => category.Name))
                                {
                                    <option value="@category.Id">@category.Name</option>
                                }
                            </select>
                        </div>
                    }
                </div>
            </div>
            <div class="card-body">
                @{
                    var storefrontProducts = GetStorefrontProducts().ToList();
                }
                @if (storefrontProducts.Count > 0)
                {
                    <div class="row g-3">
                        @foreach (var product in storefrontProducts)
                        {
                            <div class="col-12 col-md-6 col-xl-4">
                                <div class="border rounded p-3 h-100 d-flex flex-column">
                                    <div class="mb-2">
                                        <h3 class="h6 mb-1">@product.Name</h3>
                                        <div class="text-muted small">@GetCategoryName(product.CategoryId)</div>
                                    </div>
                                    <p class="text-muted small flex-grow-1 mb-3">
                                        @(!string.IsNullOrWhiteSpace(product.Description) ? product.Description : "No description provided.")
                                    </p>
                                    <div class="d-flex justify-content-between align-items-end mt-auto">
                                        <div>
                                            <div class="fw-semibold">@product.Price.ToString("C")</div>
                                            <div class="text-muted small">
                                                @(product.StockQuantity > 0 ? $"{product.StockQuantity} in stock" : "Out of stock")
                                            </div>
                                        </div>
                                        <button class="btn btn-sm btn-primary"
                                                disabled="@(product.StockQuantity <= 0 || !product.IsActive || !CanIncreaseQuantity(product.Id))"
                                                @onclick="@(() => AddProductToCart(product))">
                                            <span class="oi oi-cart me-1" aria-hidden="true"></span>
                                            Add
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-muted fst-italic">No products available in this category.</div>
                }
            </div>
        </section>
        <section class="card shadow-sm border-0 mb-5">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h2 class="h5 mb-0">Cart</h2>
                @if (cartLines.Count > 0)
                {
                    <button class="btn btn-sm btn-outline-secondary" @onclick="ClearCart">Clear cart</button>
                }
            </div>
            <div class="card-body">
                @if (!string.IsNullOrWhiteSpace(cartErrorMessage))
                {
                    <div class="alert alert-danger">@cartErrorMessage</div>
                }
                @if (cartLines.Count == 0)
                {
                    <div class="text-muted fst-italic">Add products to your cart to place an order.</div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table align-middle">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th class="text-center" style="width: 180px;">Quantity</th>
                                    <th class="text-end" style="width: 150px;">Line total</th>
                                    <th class="text-end" style="width: 1%;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var line in cartLines)
                                {
                                    <tr>
                                        <td>
                                            <div class="fw-semibold">@line.Name</div>
                                            <div class="text-muted small">@line.Price.ToString("C") each</div>
                                        </td>
                                        <td>
                                            <div class="d-flex justify-content-center align-items-center gap-2">
                                                <button class="btn btn-sm btn-outline-secondary" @onclick="@(() => DecreaseCartQuantity(line.ProductId))">
                                                    <span class="oi oi-minus" aria-hidden="true"></span>
                                                </button>
                                                <span class="fw-semibold">@line.Quantity</span>
                                                <button class="btn btn-sm btn-outline-secondary"
                                                        disabled="@(CanIncreaseQuantity(line.ProductId) ? false : true)"
                                                        @onclick="@(() => IncreaseCartQuantity(line.ProductId))">
                                                    <span class="oi oi-plus" aria-hidden="true"></span>
                                                </button>
                                            </div>
                                        </td>
                                        <td class="text-end fw-semibold">@line.LineTotal.ToString("C")</td>
                                        <td class="text-end">
                                            <button class="btn btn-sm btn-outline-danger" @onclick="@(() => RemoveFromCart(line.ProductId))">
                                                <span class="oi oi-trash" aria-hidden="true"></span>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between mt-4">
                        <div class="fs-5 mb-3 mb-lg-0">Total: <strong>@CartTotal.ToString("C")</strong></div>
                        <div class="text-lg-end">
                            <button class="btn btn-primary w-100"
                                    disabled="@(!CanPlaceOrder || isPlacingOrder)"
                                    @onclick="PlaceOrderAsync">
                                @if (isPlacingOrder)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                }
                                Place order
                            </button>
                            <div class="text-muted small mt-2">
                                Pay on delivery · Settle when you receive your order. The pharmacy will mark the payment as done afterward.
                            </div>
                        </div>
                    </div>
                }
            </div>
        </section>
    }

    @if (canManageCatalog)
    {
        <section class="mb-5" id="categories">
        <div class="d-flex flex-column flex-md-row align-items-md-center mb-3 gap-3">
            <h2 class="h4 mb-0">Categories</h2>
            <span class="badge bg-secondary">@categories.Count @(categories.Count == 1 ? "category" : "categories")</span>
            @if (canManageCatalog)
            {
                <button class="btn btn-outline-primary ms-md-auto" @onclick="ShowCreateCategoryForm">
                    <span class="oi oi-plus me-1" aria-hidden="true"></span>
                    New category
                </button>
            }
        </div>

        @if (categories.Count == 0)
        {
            <div class="alert alert-info">No categories yet.</div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Status</th>
                            @if (canManageCatalog)
                            {
                                <th style="width: 160px;"></th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var category in categories)
                        {
                            <tr>
                                <td>@category.Name</td>
                                <td>@(string.IsNullOrWhiteSpace(category.Description) ? "—" : category.Description)</td>
                                <td>
                                    <span class="badge bg-@GetStatusColor(category.IsActive)">
                                        @(category.IsActive ? "Active" : "Inactive")
                                    </span>
                                </td>
                                @if (canManageCatalog)
                                {
                                    <td>
                                        <div class="d-flex gap-2 justify-content-end">
                                            <button class="btn btn-sm btn-outline-secondary" @onclick="() => BeginEditCategory(category)">
                                                <span class="oi oi-pencil" aria-hidden="true"></span>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" @onclick="() => ToggleCategoryDelete(category.Id)">
                                                <span class="oi oi-trash" aria-hidden="true"></span>
                                            </button>
                                        </div>
                                        @if (categoryDeleteCandidate == category.Id)
                                        {
                                            <div class="alert alert-warning mt-2 mb-0">
                                                <div class="small">Delete <strong>@category.Name</strong>?</div>
                                                <div class="mt-2 d-flex gap-2">
                                                    <button class="btn btn-danger btn-sm" disabled="@isSavingCategory" @onclick="() => ConfirmDeleteCategoryAsync(category.Id)">
                                                        Delete
                                                    </button>
                                                    <button class="btn btn-outline-secondary btn-sm" @onclick="CancelCategoryDelete">Cancel</button>
                                                </div>
                                            </div>
                                        }
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }

        @if (canManageCatalog && showCategoryForm)
        {
            <div class="card shadow-sm border-0 mt-4">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="h5 mb-0">@((editingCategoryId is null) ? "Create category" : "Update category")</h3>
                        <button class="btn btn-sm btn-outline-secondary" @onclick="HideCategoryForm">Close</button>
                    </div>
                </div>
                <div class="card-body">
                    <EditForm Model="@categoryForm" OnValidSubmit="HandleCategorySubmitAsync">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <InputText class="form-control" @bind-Value="categoryForm.Name" />
                            <ValidationMessage For="@(() => categoryForm.Name)" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <InputTextArea class="form-control" @bind-Value="categoryForm.Description" rows="3" />
                            <ValidationMessage For="@(() => categoryForm.Description)" />
                        </div>

                        @if (editingCategoryId is not null)
                        {
                            <div class="form-check form-switch mb-3">
                                <InputCheckbox class="form-check-input" @bind-Value="categoryForm.IsActive" />
                                <label class="form-check-label">@((categoryForm.IsActive ? "Active" : "Inactive"))</label>
                            </div>
                        }

                        <button class="btn btn-primary" type="submit" disabled="@isSavingCategory">
                            @if (isSavingCategory)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            }
                            @((editingCategoryId is null) ? "Create category" : "Save changes")
                        </button>
                    </EditForm>
                </div>
            </div>
        }
    </section>
    <section class="mb-5" id="products">
        <div class="d-flex flex-column flex-md-row align-items-md-center mb-3 gap-3">
            <h2 class="h4 mb-0">Products</h2>
            <span class="badge bg-secondary">@products.Count @(products.Count == 1 ? "product" : "products")</span>
            @if (canManageCatalog && categories.Count > 0)
            {
                <button class="btn btn-outline-primary ms-md-auto" @onclick="ShowCreateProductForm">
                    <span class="oi oi-plus me-1" aria-hidden="true"></span>
                    New product
                </button>
            }
            else if (canManageCatalog && categories.Count == 0)
            {
                <span class="text-muted small ms-md-auto">Add a category to enable product management.</span>
            }
        </div>

        @if (products.Count == 0)
        {
            <div class="alert alert-info">No products yet.</div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Name</th>
                            <th>Category</th>
                            <th class="text-end">Price</th>
                            <th class="text-end">Stock</th>
                            <th>Status</th>
                            @if (canManageCatalog)
                            {
                                <th style="width: 160px;"></th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var product in products)
                        {
                            <tr>
                                <td>@product.Name</td>
                                <td>@GetCategoryName(product.CategoryId)</td>
                                <td class="text-end">@product.Price.ToString("C")</td>
                                <td class="text-end">@product.StockQuantity</td>
                                <td>
                                    <span class="badge bg-@GetStatusColor(product.IsActive)">
                                        @(product.IsActive ? "Active" : "Inactive")
                                    </span>
                                </td>
                                @if (canManageCatalog)
                                {
                                    <td>
                                        <div class="d-flex gap-2 justify-content-end">
                                            <button class="btn btn-sm btn-outline-secondary" @onclick="() => BeginEditProduct(product)">
                                                <span class="oi oi-pencil" aria-hidden="true"></span>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" @onclick="() => ToggleProductDelete(product.Id)">
                                                <span class="oi oi-trash" aria-hidden="true"></span>
                                            </button>
                                        </div>
                                        @if (productDeleteCandidate == product.Id)
                                        {
                                            <div class="alert alert-warning mt-2 mb-0">
                                                <div class="small">Delete <strong>@product.Name</strong>?</div>
                                                <div class="mt-2 d-flex gap-2">
                                                    <button class="btn btn-danger btn-sm" disabled="@isSavingProduct" @onclick="() => ConfirmDeleteProductAsync(product.Id)">
                                                        Delete
                                                    </button>
                                                    <button class="btn btn-outline-secondary btn-sm" @onclick="CancelProductDelete">Cancel</button>
                                                </div>
                                            </div>
                                        }
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }

        @if (canManageCatalog && showProductForm)
        {
            <div class="card shadow-sm border-0 mt-4">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="h5 mb-0">@((editingProductId is null) ? "Create product" : "Update product")</h3>
                        <button class="btn btn-sm btn-outline-secondary" @onclick="HideProductForm">Close</button>
                    </div>
                </div>
                <div class="card-body">
                    <EditForm Model="@productForm" OnValidSubmit="HandleProductSubmitAsync">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Name</label>
                                <InputText class="form-control" @bind-Value="productForm.Name" />
                                <ValidationMessage For="@(() => productForm.Name)" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Category</label>
                                <InputSelect class="form-select" @bind-Value="productForm.CategoryId">
                                    <option value="@Guid.Empty">Select category</option>
                                    @foreach (var category in categories)
                                    {
                                        <option value="@category.Id">@category.Name</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => productForm.CategoryId)" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Price</label>
                                <InputNumber class="form-control" @bind-Value="productForm.Price" />
                                <ValidationMessage For="@(() => productForm.Price)" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Stock quantity</label>
                                <InputNumber class="form-control" @bind-Value="productForm.StockQuantity" />
                                <ValidationMessage For="@(() => productForm.StockQuantity)" />
                            </div>
                            <div class="col-12">
                                <label class="form-label">Description</label>
                                <InputTextArea class="form-control" @bind-Value="productForm.Description" rows="3" />
                                <ValidationMessage For="@(() => productForm.Description)" />
                            </div>
                        </div>

                        @if (editingProductId is not null)
                        {
                            <div class="form-check form-switch mt-3">
                                <InputCheckbox class="form-check-input" @bind-Value="productForm.IsActive" />
                                <label class="form-check-label">@((productForm.IsActive ? "Active" : "Inactive"))</label>
                            </div>
                        }

                        <button class="btn btn-primary mt-3" type="submit" disabled="@isSavingProduct">
                            @if (isSavingProduct)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            }
                            @((editingProductId is null) ? "Create product" : "Save changes")
                        </button>
                    </EditForm>
                </div>
            </div>
        }
    </section>
    }

    @if (!isClient)
    {
    <section class="mb-5" id="orders">
        <div class="d-flex flex-column flex-md-row align-items-md-center gap-3 mb-3">
            <h2 class="h4 mb-0">Orders</h2>
            <span class="badge bg-secondary">@orders.Count @(orders.Count == 1 ? "order" : "orders")</span>
            <div class="ms-md-auto text-muted small">Latest first</div>
        </div>

        @if (orders.Count == 0)
        {
            <div class="alert alert-info">No order history available.</div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Order #</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th class="text-end">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var order in orders)
                        {
                            <tr>
                                <td>@order.OrderNumber</td>
                                <td>@order.OrderedAt.LocalDateTime.ToString("dd MMM yyyy HH:mm")</td>
                                <td>@order.Status</td>
                                <td class="text-end">@order.TotalAmount.ToString("C")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </section>

    <section class="mb-5" id="payments">
        <div class="d-flex flex-column flex-lg-row align-items-lg-center gap-3 mb-3">
            <h2 class="h4 mb-0">Payments</h2>
            <span class="badge bg-secondary">@payments.Count @(payments.Count == 1 ? "payment" : "payments")</span>
            @if (orders.Count > 0)
            {
                <div class="ms-lg-auto">
                    <label class="form-label me-2 mb-0">Filter by order</label>
                    <select class="form-select d-inline-block w-auto" @onchange="OnOrderFilterChanged">
                        <option value="">All orders</option>
                        @foreach (var order in orders)
                        {
                            <option value="@order.Id" selected="@(selectedOrderIdForPayments == order.Id)">
                                @order.OrderNumber
                            </option>
                        }
                    </select>
                </div>
            }
        </div>

        @if (isLoadingPayments)
        {
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading payments...</span>
                </div>
            </div>
        }
        else if (payments.Count == 0)
        {
            <div class="alert alert-info">No payments found for this filter.</div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Payment</th>
                            <th>Order #</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Method</th>
                            <th class="text-end">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var payment in payments)
                        {
                            <tr>
                                <td>@payment.Id.ToString()[..8]...</td>
                                <td>@GetOrderNumber(payment.OrderId)</td>
                                <td>@payment.PaidAt.LocalDateTime.ToString("dd MMM yyyy HH:mm")</td>
                                <td>
                                    <div class="d-flex flex-wrap align-items-center gap-2">
                                        <span>@payment.Status</span>
                                        @if (canManagePayments && IsPendingPayment(payment.Status))
                                        {
                                            <button type="button"
                                                    class="btn btn-sm btn-outline-success"
                                                    disabled="@(updatingPaymentId == payment.Id)"
                                                    @onclick="@(() => MarkPaymentAsDoneAsync(payment.Id))">
                                                @if (updatingPaymentId == payment.Id)
                                                {
                                                    <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                                                }
                                                Mark as done
                                            </button>
                                        }
                                    </div>
                                </td>
                                <td>@payment.Method</td>
                                <td class="text-end">@payment.Amount.ToString("C")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </section>
    }
}
@code {
    [Parameter]
    public Guid PharmacyId { get; set; }

    private PharmacyDetailsModel? pharmacy;
    private readonly List<CategoryModel> categories = [];
    private readonly List<ProductModel> products = [];
    private readonly List<OrderSummaryModel> orders = [];
    private readonly List<PaymentModel> payments = [];

    private bool isLoading = true;
    private bool isLoadingPayments;
    private bool canManagePharmacy;
    private bool canManageCatalog;
    private bool canManagePayments;
    private bool isClient;
    private Guid? selectedCategoryId;
    private readonly List<CartLineModel> cartLines = [];
    private bool isPlacingOrder;
    private string? cartErrorMessage;
    private string? errorMessage;
    private string? alertMessage;
    private string alertStyle = "success";

    private bool showPharmacyEdit;
    private bool showCategoryForm;
    private bool showProductForm;
    private Guid? editingCategoryId;
    private Guid? editingProductId;
    private Guid? categoryDeleteCandidate;
    private Guid? productDeleteCandidate;
    private Guid? selectedOrderIdForPayments;
    private Guid? updatingPaymentId;

    private bool isSavingPharmacy;
    private bool isSavingCategory;
    private bool isSavingProduct;

    private readonly PharmacyEditModel pharmacyForm = new();
    private readonly CategoryFormModel categoryForm = new();
    private readonly ProductFormModel productForm = new();

    protected override async Task OnParametersSetAsync()
    {
        await ResolveRolesAsync();
        await LoadAllAsync();
    }

    private async Task ResolveRolesAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var hasAdminRole = HasRole(user, "admin");
        var hasPharmacyRole = HasRole(user, "pharmacy");
        canManagePharmacy = hasAdminRole;
        canManageCatalog = hasAdminRole || hasPharmacyRole;
        canManagePayments = hasAdminRole || hasPharmacyRole;
        isClient = !hasAdminRole && !hasPharmacyRole && HasRole(user, "client");
    }

    private async Task LoadAllAsync()
    {
        isLoading = true;
        alertMessage = null;
        errorMessage = null;

        try
        {
            var detail = await CmsApiClient.GetPharmacyAsync(PharmacyId);
            if (detail is null)
            {
                errorMessage = "This pharmacy could not be found or you do not have access to it.";
                return;
            }

              pharmacy = detail;
              pharmacyForm.LoadFrom(detail);

              await LoadCategoriesAsync();
              await LoadProductsAsync();
              if (canManageCatalog || canManagePharmacy)
              {
                  await LoadOrdersAsync();
              }
              if (canManagePayments)
              {
                  await LoadPaymentsAsync();
              }
          }
          catch (Exception ex)
          {
              errorMessage = ex.Message;
          }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadCategoriesAsync()
    {
        categories.Clear();
        var result = await CmsApiClient.GetCategoriesAsync(PharmacyId);
        categories.AddRange(result.OrderBy(c => c.Name));
    }

    private async Task LoadProductsAsync()
    {
        products.Clear();
        var result = await CmsApiClient.GetProductsAsync(PharmacyId);
        products.AddRange(result.OrderBy(p => p.Name));
        ReconcileCartWithStock();
    }

    private IEnumerable<ProductModel> GetStorefrontProducts()
    {
        var query = products.Where(product => product.IsActive);

        if (selectedCategoryId.HasValue)
        {
            query = query.Where(product => product.CategoryId == selectedCategoryId.Value);
        }

        return query.OrderBy(product => product.Name);
    }

    private void OnCategoryFilterChanged(ChangeEventArgs args)
    {
        cartErrorMessage = null;
        if (Guid.TryParse(args.Value?.ToString(), out var categoryId))
        {
            selectedCategoryId = categoryId;
        }
        else
        {
            selectedCategoryId = null;
        }
    }

    private void AddProductToCart(ProductModel product)
    {
        cartErrorMessage = null;

        if (!product.IsActive || product.StockQuantity <= 0)
        {
            SetAlert($"{product.Name} is not available at the moment.", "warning");
            return;
        }

        var existingLine = cartLines.FirstOrDefault(line => line.ProductId == product.Id);
        var availableStock = GetProductAvailableStock(product.Id);

        if (availableStock <= 0)
        {
            SetAlert($"{product.Name} is out of stock.", "warning");
            return;
        }

        if (existingLine is null)
        {
            cartLines.Add(new CartLineModel(product.Id, product.Name, product.Price));
            return;
        }

        if (existingLine.Quantity >= availableStock)
        {
            SetAlert($"Only {availableStock} units of {product.Name} are available.", "warning");
            return;
        }

        existingLine.Increment();
    }

    private void IncreaseCartQuantity(Guid productId)
    {
        cartErrorMessage = null;
        var line = cartLines.FirstOrDefault(item => item.ProductId == productId);
        if (line is null)
        {
            return;
        }

        var availableStock = GetProductAvailableStock(productId);
        if (availableStock <= 0)
        {
            SetAlert($"{line.Name} is currently out of stock.", "warning");
            return;
        }

        if (line.Quantity >= availableStock)
        {
            SetAlert($"Only {availableStock} units of {line.Name} are available.", "warning");
            return;
        }

        line.Increment();
    }

    private void DecreaseCartQuantity(Guid productId)
    {
        cartErrorMessage = null;
        var line = cartLines.FirstOrDefault(item => item.ProductId == productId);
        if (line is null)
        {
            return;
        }

        if (line.Quantity <= 1)
        {
            cartLines.Remove(line);
            return;
        }

        line.Decrement();
    }

    private void RemoveFromCart(Guid productId)
    {
        cartErrorMessage = null;
        cartLines.RemoveAll(line => line.ProductId == productId);
    }

    private void ClearCart()
    {
        cartLines.Clear();
        cartErrorMessage = null;
    }

    private bool CanIncreaseQuantity(Guid productId)
    {
        var line = cartLines.FirstOrDefault(item => item.ProductId == productId);
        var availableStock = GetProductAvailableStock(productId);
        if (availableStock <= 0)
        {
            return false;
        }

        if (line is null)
        {
            return true;
        }

        return line.Quantity < availableStock;
    }

    private int GetProductAvailableStock(Guid productId)
    {
        return products.FirstOrDefault(product => product.Id == productId)?.StockQuantity ?? 0;
    }

    private decimal CartTotal => cartLines.Sum(line => line.LineTotal);

    private bool CanPlaceOrder =>
        cartLines.Count > 0 &&
        cartLines.All(line =>
        {
            var available = GetProductAvailableStock(line.ProductId);
            return available > 0 && line.Quantity <= available;
        });

    private void ReconcileCartWithStock()
    {
        if (cartLines.Count == 0)
        {
            return;
        }

        foreach (var line in cartLines.ToList())
        {
            var available = GetProductAvailableStock(line.ProductId);
            if (available <= 0)
            {
                cartLines.Remove(line);
            }
            else if (line.Quantity > available)
            {
                line.SetQuantity(available);
            }
        }
    }

    private async Task PlaceOrderAsync()
    {
        if (!CanPlaceOrder)
        {
            cartErrorMessage = "Please review your cart before placing the order.";
            return;
        }

        isPlacingOrder = true;
        cartErrorMessage = null;

        try
        {
            var request = new CreateOrderRequest(
                cartLines
                    .Select(line => new CreateOrderLineRequest(line.ProductId, line.Quantity))
                    .ToArray());

            var result = await CmsApiClient.CreateOrderAsync(PharmacyId, request);

            PaymentModel? paymentRecord = null;
            string? paymentError = null;
            try
            {
                paymentRecord = await CmsApiClient.EnsurePayOnDeliveryPaymentAsync(
                    PharmacyId,
                    new CreatePaymentRequest(result.OrderId));
            }
            catch (Exception paymentEx)
            {
                paymentError = paymentEx.Message;
            }

            if (!string.IsNullOrWhiteSpace(paymentError))
            {
                SetAlert(
                    $"Order {result.OrderNumber} placed, but we couldn't create the payment record: {paymentError}",
                    "warning");
            }
            else if (paymentRecord is not null)
            {
                var paymentReference = paymentRecord.Id.ToString()[..8].ToUpperInvariant();
                SetAlert(
                    $"Order {result.OrderNumber} placed successfully. Payment reference {paymentReference} recorded as pay on delivery.",
                    "success");
            }
            else
            {
                SetAlert($"Order {result.OrderNumber} placed successfully. Pay on delivery when your order arrives.", "success");
            }
            cartLines.Clear();

            await LoadProductsAsync();
            if (!isClient)
            {
                await LoadOrdersAsync();
            }
            if (canManagePayments)
            {
                await LoadPaymentsAsync();
            }
        }
        catch (Exception ex)
        {
            cartErrorMessage = ex.Message;
            SetAlert($"Failed to place order: {ex.Message}", "danger");
        }
        finally
        {
            isPlacingOrder = false;
        }
    }

    private async Task LoadOrdersAsync()
    {
        orders.Clear();
        var result = await CmsApiClient.GetOrdersAsync(PharmacyId);
        orders.AddRange(result.OrderByDescending(o => o.OrderedAt));
    }

    private async Task LoadPaymentsAsync()
    {
        isLoadingPayments = true;
        payments.Clear();
        try
        {
            var result = await CmsApiClient.GetPaymentsAsync(PharmacyId, selectedOrderIdForPayments);
            payments.AddRange(result.OrderByDescending(p => p.PaidAt));
        }
        finally
        {
            isLoadingPayments = false;
        }
    }

    private static bool IsPendingPayment(string? status) =>
        string.IsNullOrWhiteSpace(status) ||
        status.Equals("pending", StringComparison.OrdinalIgnoreCase);

    private async Task MarkPaymentAsDoneAsync(Guid paymentId)
    {
        if (!canManagePayments)
        {
            return;
        }

        const string targetStatus = "Done";
        updatingPaymentId = paymentId;
        try
        {
            await CmsApiClient.UpdatePaymentStatusAsync(
                PharmacyId,
                paymentId,
                new UpdatePaymentStatusRequest(targetStatus));

            var index = payments.FindIndex(payment => payment.Id == paymentId);
            if (index >= 0)
            {
                payments[index] = payments[index] with { Status = targetStatus };

                var orderIndex = orders.FindIndex(order => order.Id == payments[index].OrderId);
                if (orderIndex >= 0)
                {
                    orders[orderIndex] = orders[orderIndex] with { Status = targetStatus };
                }
            }

            SetAlert("Payment marked as done.", "success");
        }
        catch (Exception ex)
        {
            SetAlert($"Failed to update payment: {ex.Message}", "danger");
        }
        finally
        {
            updatingPaymentId = null;
        }
    }

    private async Task HandlePharmacyUpdateAsync()
    {
        if (pharmacy is null)
        {
            return;
        }

        isSavingPharmacy = true;
        try
        {
            var request = new UpdatePharmacyRequest(
                pharmacyForm.Name,
                pharmacyForm.Description,
                pharmacyForm.Address,
                pharmacyForm.IsActive);

            await CmsApiClient.UpdatePharmacyAsync(pharmacy.Id, request);
            SetAlert("Pharmacy updated.", "success");
            showPharmacyEdit = false;
            await LoadAllAsync();
        }
        catch (Exception ex)
        {
            SetAlert($"Failed to update pharmacy: {ex.Message}", "danger");
        }
        finally
        {
            isSavingPharmacy = false;
        }
    }

    private void TogglePharmacyEdit()
    {
        if (pharmacy is null)
        {
            return;
        }

        showPharmacyEdit = !showPharmacyEdit;
        if (showPharmacyEdit)
        {
            pharmacyForm.LoadFrom(pharmacy);
        }
    }

    private void ShowCreateCategoryForm()
    {
        editingCategoryId = null;
        categoryForm.Reset();
        showCategoryForm = true;
        categoryDeleteCandidate = null;
    }

    private void BeginEditCategory(CategoryModel category)
    {
        editingCategoryId = category.Id;
        categoryForm.LoadFrom(category);
        showCategoryForm = true;
        categoryDeleteCandidate = null;
    }

    private void HideCategoryForm()
    {
        showCategoryForm = false;
        editingCategoryId = null;
    }

    private async Task HandleCategorySubmitAsync()
    {
        isSavingCategory = true;
        try
        {
            if (editingCategoryId is null)
            {
                var request = new CreateCategoryRequest(categoryForm.Name, categoryForm.Description);
                await CmsApiClient.CreateCategoryAsync(PharmacyId, request);
                SetAlert("Category created.", "success");
            }
            else
            {
                var request = new UpdateCategoryRequest(categoryForm.Name, categoryForm.Description, categoryForm.IsActive);
                await CmsApiClient.UpdateCategoryAsync(PharmacyId, editingCategoryId.Value, request);
                SetAlert("Category updated.", "success");
            }

            showCategoryForm = false;
            editingCategoryId = null;
            categoryForm.Reset();
            await LoadCategoriesAsync();
            await LoadProductsAsync();
        }
        catch (Exception ex)
        {
            SetAlert($"Category operation failed: {ex.Message}", "danger");
        }
        finally
        {
            isSavingCategory = false;
        }
    }

    private void ToggleCategoryDelete(Guid categoryId)
    {
        categoryDeleteCandidate = categoryDeleteCandidate == categoryId ? null : categoryId;
    }

    private void CancelCategoryDelete()
    {
        categoryDeleteCandidate = null;
    }

    private async Task ConfirmDeleteCategoryAsync(Guid categoryId)
    {
        isSavingCategory = true;
        try
        {
            await CmsApiClient.DeleteCategoryAsync(PharmacyId, categoryId);
            SetAlert("Category deleted.", "info");
            categoryDeleteCandidate = null;
            await LoadCategoriesAsync();
            await LoadProductsAsync();
        }
        catch (Exception ex)
        {
            SetAlert($"Failed to delete category: {ex.Message}", "danger");
        }
        finally
        {
            isSavingCategory = false;
        }
    }

    private void ShowCreateProductForm()
    {
        editingProductId = null;
        productForm.Reset();
        productForm.IsActive = true;
        showProductForm = true;
        productDeleteCandidate = null;
    }

    private void BeginEditProduct(ProductModel product)
    {
        editingProductId = product.Id;
        productForm.LoadFrom(product);
        showProductForm = true;
        productDeleteCandidate = null;
    }

    private void HideProductForm()
    {
        showProductForm = false;
        editingProductId = null;
    }

    private async Task HandleProductSubmitAsync()
    {
        isSavingProduct = true;
        try
        {
            if (editingProductId is null)
            {
                var request = new CreateProductRequest(
                    productForm.CategoryId,
                    productForm.Name,
                    productForm.Description,
                    productForm.Price,
                    productForm.StockQuantity);

                await CmsApiClient.CreateProductAsync(PharmacyId, request);
                SetAlert("Product created.", "success");
            }
            else
            {
                var request = new UpdateProductRequest(
                    productForm.Name,
                    productForm.Description,
                    productForm.Price,
                    productForm.StockQuantity,
                    productForm.IsActive);

                await CmsApiClient.UpdateProductAsync(PharmacyId, editingProductId.Value, request);
                SetAlert("Product updated.", "success");
            }

            showProductForm = false;
            editingProductId = null;
            productForm.Reset();
            await LoadProductsAsync();
        }
        catch (Exception ex)
        {
            SetAlert($"Product operation failed: {ex.Message}", "danger");
        }
        finally
        {
            isSavingProduct = false;
        }
    }

    private void ToggleProductDelete(Guid productId)
    {
        productDeleteCandidate = productDeleteCandidate == productId ? null : productId;
    }

    private void CancelProductDelete()
    {
        productDeleteCandidate = null;
    }

    private async Task ConfirmDeleteProductAsync(Guid productId)
    {
        isSavingProduct = true;
        try
        {
            await CmsApiClient.DeleteProductAsync(PharmacyId, productId);
            SetAlert("Product deleted.", "info");
            productDeleteCandidate = null;
            await LoadProductsAsync();
        }
        catch (Exception ex)
        {
            SetAlert($"Failed to delete product: {ex.Message}", "danger");
        }
        finally
        {
            isSavingProduct = false;
        }
    }

    private async Task OnOrderFilterChanged(ChangeEventArgs args)
    {
        var value = args.Value?.ToString();
        selectedOrderIdForPayments = Guid.TryParse(value, out var parsed) ? parsed : null;
        await LoadPaymentsAsync();
    }

    private void NavigateHome()
    {
        NavigationManager.NavigateTo("/");
    }

    private static bool HasRole(ClaimsPrincipal? user, string role)
    {
        if (user is null)
        {
            return false;
        }

        if (user.Claims.Any(claim =>
                string.Equals(claim.Value, role, StringComparison.OrdinalIgnoreCase) &&
                (string.Equals(claim.Type, ClaimTypes.Role, StringComparison.OrdinalIgnoreCase) ||
                 string.Equals(claim.Type, "role", StringComparison.OrdinalIgnoreCase))))
        {
            return true;
        }

        var realmAccess = user.Claims.FirstOrDefault(c => c.Type == "realm_access")?.Value;
        if (TryReadRolesFromJson(realmAccess, out var rolesFromRealm) &&
            rolesFromRealm.Contains(role, StringComparer.OrdinalIgnoreCase))
        {
            return true;
        }

        var resourceAccess = user.Claims.FirstOrDefault(c => c.Type == "resource_access")?.Value;
        if (TryReadRolesFromResourceAccess(resourceAccess, out var rolesFromResources) &&
            rolesFromResources.Contains(role, StringComparer.OrdinalIgnoreCase))
        {
            return true;
        }

        return false;
    }

    private static bool TryReadRolesFromJson(string? json, out HashSet<string> roles)
    {
        roles = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        if (string.IsNullOrWhiteSpace(json))
        {
            return false;
        }

        try
        {
            using var doc = JsonDocument.Parse(json);
            if (doc.RootElement.TryGetProperty("roles", out var rolesArray))
            {
                foreach (var item in rolesArray.EnumerateArray())
                {
                    var value = item.GetString();
                    if (!string.IsNullOrWhiteSpace(value))
                    {
                        roles.Add(value);
                    }
                }
            }
        }
        catch
        {
            return false;
        }

        return roles.Count > 0;
    }

    private static bool TryReadRolesFromResourceAccess(string? json, out HashSet<string> roles)
    {
        roles = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        if (string.IsNullOrWhiteSpace(json))
        {
            return false;
        }

        try
        {
            using var doc = JsonDocument.Parse(json);
            foreach (var resource in doc.RootElement.EnumerateObject())
            {
                if (resource.Value.TryGetProperty("roles", out var rolesArray))
                {
                    foreach (var item in rolesArray.EnumerateArray())
                    {
                        var value = item.GetString();
                        if (!string.IsNullOrWhiteSpace(value))
                        {
                            roles.Add(value);
                        }
                    }
                }
            }
        }
        catch
        {
            return false;
        }

        return roles.Count > 0;
    }

    private string GetCategoryName(Guid categoryId)
    {
        return categories.FirstOrDefault(c => c.Id == categoryId)?.Name ?? "-";
    }

    private string GetOrderNumber(Guid orderId)
    {
        return orders.FirstOrDefault(o => o.Id == orderId)?.OrderNumber ?? "—";
    }

    private void SetAlert(string message, string style)
    {
        alertMessage = message;
        alertStyle = style;
    }

    private static string GetStatusColor(bool isActive) => isActive ? "success" : "secondary";

    private sealed class CartLineModel
    {
        public CartLineModel(Guid productId, string name, decimal price)
        {
            ProductId = productId;
            Name = name;
            Price = price;
            Quantity = 1;
        }

        public Guid ProductId { get; }
        public string Name { get; }
        public decimal Price { get; }
        public int Quantity { get; private set; }

        public decimal LineTotal => Price * Quantity;

        public void Increment()
        {
            Quantity++;
        }

        public void Decrement()
        {
            if (Quantity > 0)
            {
                Quantity--;
            }
        }

        public void SetQuantity(int quantity)
        {
            if (quantity <= 0)
            {
                throw new ArgumentOutOfRangeException(nameof(quantity));
            }

            Quantity = quantity;
        }
    }

    private sealed class PharmacyEditModel
    {
        [Required]
        [StringLength(200)]
        public string Name { get; set; } = string.Empty;

        [StringLength(500)]
        public string? Description { get; set; }

        [StringLength(400)]
        public string? Address { get; set; }

        public bool IsActive { get; set; }

        public void LoadFrom(PharmacyDetailsModel details)
        {
            Name = details.Name;
            Description = details.Description;
            Address = details.Address;
            IsActive = details.IsActive;
        }
    }

    private sealed class CategoryFormModel
    {
        [Required]
        [StringLength(150)]
        public string Name { get; set; } = string.Empty;

        [StringLength(400)]
        public string? Description { get; set; }

        public bool IsActive { get; set; } = true;

        public void LoadFrom(CategoryModel category)
        {
            Name = category.Name;
            Description = category.Description;
            IsActive = category.IsActive;
        }

        public void Reset()
        {
            Name = string.Empty;
            Description = null;
            IsActive = true;
        }
    }

    private sealed class ProductFormModel
    {
        [Required]
        public Guid CategoryId { get; set; }

        [Required]
        [StringLength(150)]
        public string Name { get; set; } = string.Empty;

        [StringLength(500)]
        public string? Description { get; set; }

        [Range(typeof(decimal), "0.00", "9999999.99", ErrorMessage = "Price must be zero or positive.")]
        public decimal Price { get; set; }

        [Range(0, int.MaxValue)]
        public int StockQuantity { get; set; }

        public bool IsActive { get; set; } = true;

        public void LoadFrom(ProductModel product)
        {
            CategoryId = product.CategoryId;
            Name = product.Name;
            Description = product.Description;
            Price = product.Price;
            StockQuantity = product.StockQuantity;
            IsActive = product.IsActive;
        }

        public void Reset()
        {
            CategoryId = Guid.Empty;
            Name = string.Empty;
            Description = null;
            Price = 0;
            StockQuantity = 0;
            IsActive = true;
        }
    }
}
