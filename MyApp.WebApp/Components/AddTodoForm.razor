@using MyApp.Persistence
@using MyApp.WebApp.Clients
@inject ITodoClient Client
@implements IDisposable

<EditForm EditContext="editContext" OnValidSubmit="Submit" FormName="add-todo-item-form">
    <h4>Add a new todo</h4>
    <div class="mb-3">
        <label for="todoItem" class="form-label">Title</label>
        <InputText type="text" class="form-control" id="todoItem" placeholder="Enter todo item" @bind-Value="Model!.Title" required />
    </div>

    <div>
        <ValidationMessage For="() => Model!.Title" />
    </div>

    <button type="submit" class="btn btn-primary">Add Title</button>
</EditForm>

@code {
    [SupplyParameterFromForm]
    private TodoFormItem? Model { get; set; }

    private EditContext? editContext;
    private ValidationMessageStore? messageStore;

    [Parameter]
    public EventCallback OnTodoAdded { get; set; }

    protected override void OnInitialized()
    {
        Model ??= new TodoFormItem();
        ConfigureEditContext();
    }

    private void ConfigureEditContext()
    {
        if (editContext is not null)
        {
            editContext.OnValidationRequested -= HandleValidationRequested;
        }

        editContext = new EditContext(Model!);
        editContext.OnValidationRequested += HandleValidationRequested;
        messageStore = new ValidationMessageStore(editContext);
    }

    private void HandleValidationRequested(object? sender, ValidationRequestedEventArgs args)
    {
        if (messageStore is null || Model is null)
        {
            return;
        }

        messageStore.Clear();

        if (string.IsNullOrWhiteSpace(Model.Title))
        {
            messageStore.Add(() => Model.Title, "Title is required.");
        }
        else if (Model.Title.Length > 100)
        {
            messageStore.Add(() => Model.Title, "Title cannot exceed 100 characters.");
        }
    }

    private async Task Submit()
    {
        if (Model is null)
        {
            return;
        }

        await Client.CreateTodoItemAsync(new TodoItem
        {
            Id = 0,
            Title = Model.Title,
        });

        await OnTodoAdded.InvokeAsync();

        Model = new TodoFormItem();
        ConfigureEditContext();
        StateHasChanged();
    }

    public class TodoFormItem
    {
        public string Title { get; set; } = string.Empty;
    }

    public void Dispose()
    {
        if (editContext is not null)
        {
            editContext.OnValidationRequested -= HandleValidationRequested;
        }
    }
}
